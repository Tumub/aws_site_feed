name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Working directory is implicitly repo root (./)
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Debug Connectivity (Safe)
      run: |
        echo "Validating Configuration..."
        # Print length of secrets to verify they are loaded (masked in logs)
        if [ -n "${{ secrets.HOST_IP }}" ]; then echo "HOST_IP: Loaded (Length: ${#{{ secrets.HOST_IP }}})"; else echo "HOST_IP: MISSING"; fi
        if [ -n "${{ secrets.SSH_USER }}" ]; then echo "SSH_USER: Loaded (Length: ${#{{ secrets.SSH_USER }}})"; else echo "SSH_USER: MISSING"; fi
        if [ -n "${{ secrets.SSH_KEY }}" ]; then echo "SSH_KEY: Loaded (Length: ${#{{ secrets.SSH_KEY }}})"; else echo "SSH_KEY: MISSING"; fi

    - name: Preflight SSH Check
      timeout-minutes: 1
      run: |
        echo "Testing TCP Connectivity to ${{ secrets.HOST_IP }}:22..."
        # Attempt to reach port 22. If this fails, Security Group is likely blocking GitHub.
        if nc -z -v -w 5 ${{ secrets.HOST_IP }} 22; then
            echo "âœ… Connectivity Confirmed: Port 22 is OPEN."
        else
            echo "âŒ Connectivity Error: Port 22 is BLOCKED or UNREACHABLE."
            echo "   Action Required: Check AWS Security Group inbound rules."
            echo "   Allow TCP 22 from 0.0.0.0/0 (temporary) or confirm IP allowlist."
            exit 1
        fi

    - name: Repo Guardrails (Forbidden Check)
      run: |
        chmod +x scripts/forbidden-check.sh
        bash scripts/forbidden-check.sh

    - name: Install and Build (Root)
      run: |
        npm ci
        npm run build
        
    - name: Generate Build Proof
      run: |
        SHA=$(git rev-parse --short HEAD)
        TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        echo "commit=$SHA" > dist/build-id.txt
        echo "built_at=$TS" >> dist/build-id.txt
        echo "repo=$GITHUB_REPOSITORY" >> dist/build-id.txt
        
        echo "âœ… Proof Generated:"
        cat dist/build-id.txt

    - name: Deploy to EC2
      env:
        EC2_SSH_KEY: ${{ secrets.SSH_KEY }}
        HOST: ${{ secrets.HOST_IP }}
        USER: ${{ secrets.SSH_USER }}
        LINK_PATH: /var/www/torquefoundry
        RELEASES_PATH: /var/www/releases
      run: |
        # Setup SSH
        set -euo pipefail
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh

        if [ -z "${{ secrets.HOST_IP }}" ]; then
          echo "âŒ HOST_IP secret is missing/empty"
          exit 1
        fi

        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        ssh-keyscan -H "${{ secrets.HOST_IP }}" >> ~/.ssh/known_hosts 2>/dev/null || true

        # 1. Archive build (root dist)
        tar -czf build.tar.gz -C dist .
        
        # 2. Upload to temp
        scp -i ~/.ssh/id_rsa build.tar.gz $USER@$HOST:/tmp/build.tar.gz
        
        # 3. Atomic Symlink Swap on Server
        ssh -i ~/.ssh/id_rsa $USER@$HOST << EOF
          # Stop on error
          set -e
          
          # Variables
          RELEASE_DIR=$RELEASES_PATH/release_\$(date +%s)
          
          # Prepare Directories
          sudo mkdir -p $RELEASES_PATH
          sudo mkdir -p \$RELEASE_DIR
          sudo chown $USER:$USER \$RELEASE_DIR
          
          # Extract
          tar -xzf /tmp/build.tar.gz -C \$RELEASE_DIR
          
          # Set Permissions
          sudo chown -R www-data:www-data \$RELEASE_DIR
          sudo chmod -R 755 \$RELEASE_DIR
          
          # ---------------------------------------------------------
          # DEBUG: Nginx Config Check (Instruction-based)
          # ---------------------------------------------------------
          echo "ðŸ” CHECKING NGINX ROOT CONFIGURATION..."
          # Grep for root in the site config if expected file exists, or general nginx
          if [ -f /etc/nginx/sites-enabled/torquefoundry ]; then
              grep -n "root" /etc/nginx/sites-enabled/torquefoundry || echo "No root found in site config"
              grep -n "server_name" /etc/nginx/sites-enabled/torquefoundry || echo "No server_name found"
          else
              echo "âš ï¸ /etc/nginx/sites-enabled/torquefoundry NOT FOUND. Checking default..."
              grep -r "root" /etc/nginx/sites-enabled/ || true
          fi
          
          # ---------------------------------------------------------
          # ATOMIC SWAP LOGIC
          # ---------------------------------------------------------
          
          # Handle Legacy Directory Case (Migrate if it's a dir and not a link)
          if [ -d "$LINK_PATH" ] && [ ! -L "$LINK_PATH" ]; then
            echo "Detected legacy directory at $LINK_PATH. Moving to backup..."
            sudo mv $LINK_PATH ${LINK_PATH}_backup_\$(date +%s)
          fi
          
          # Update Symlink
          # ln -sfn does atomic link replacement
          sudo ln -sfn \$RELEASE_DIR $LINK_PATH
          
          # ---------------------------------------------------------
          
          # Cleanup: Keep last 3 releases
          echo "Cleaning up old releases..."
          cd $RELEASES_PATH
          ls -dt release_* | tail -n +4 | xargs -r sudo rm -rf
          
          # Cleanup Temp
          rm /tmp/build.tar.gz
          
          # Reload Nginx
          sudo systemctl reload nginx
          
          echo "âœ… Deployment Complete. Live Release: \$RELEASE_DIR"
          
          echo "ðŸ“‚ Server-side File Verification (First 20 files):"
          ls -la \$RELEASE_DIR | head -n 20
          
          echo "ðŸ“„ Checking for build-id.txt at root of release:"
          if [ -f "\$RELEASE_DIR/build-id.txt" ]; then
              echo "FOUND: \$RELEASE_DIR/build-id.txt"
              cat "\$RELEASE_DIR/build-id.txt"
          else
              echo "âŒ ERROR: build-id.txt MISSING in \$RELEASE_DIR"
          fi
        EOF
        
        rm ~/.ssh/id_rsa

    - name: Verify Live Deployment (Build ID)
      run: |
        echo "Waiting for Nginx reload..."
        sleep 5
        echo "Checking http://${{ secrets.HOST_IP }}/build-id.txt..."
        LIVE_ID=$(curl -s --fail http://${{ secrets.HOST_IP }}/build-id.txt || echo "FETCH_FAILED")
        echo "Live Content:"
        echo "$LIVE_ID"
        
        CURRENT_SHORT_SHA=$(git rev-parse --short HEAD)
        
        if [[ "$LIVE_ID" == *"$CURRENT_SHORT_SHA"* ]]; then
          echo "âœ… VERIFIED: Live site is serving commit $CURRENT_SHORT_SHA"
        else
          echo "âŒ FAILED: Live site does not match current commit."
          echo "Expected: $CURRENT_SHORT_SHA"
          echo "Received: $LIVE_ID"
          exit 1
        fi
