name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Working directory is implicitly repo root (./)
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Setup Node
      uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Debug Connectivity (Safe)
      run: |
        echo "Validating Configuration..."
        # Assign to variables first to avoid bad substitution errors
        HOST="${{ secrets.HOST_IP }}"
        USER="${{ secrets.SSH_USER }}"
        KEY="${{ secrets.SSH_KEY }}"
        
        echo "HOST_IP loaded: $([ -n "$HOST" ] && echo YES || echo NO) (len=${#HOST})"
        echo "SSH_USER loaded: $([ -n "$USER" ] && echo YES || echo NO) (len=${#USER})"
        echo "SSH_KEY loaded: $([ -n "$KEY" ] && echo YES || echo NO) (len=${#KEY})"
        
        if [ -z "$HOST" ] || [ -z "$USER" ] || [ -z "$KEY" ]; then 
          echo "‚ùå Critical secrets missing."
          exit 1
        fi

    - name: Preflight SSH Check
      timeout-minutes: 1
      run: |
        echo "Testing TCP Connectivity to ${{ secrets.HOST_IP }}:22..."
        # Attempt to reach port 22. If this fails, Security Group is likely blocking GitHub.
        if nc -z -v -w 5 ${{ secrets.HOST_IP }} 22; then
            echo "‚úÖ Connectivity Confirmed: Port 22 is OPEN."
        else
            echo "‚ùå Connectivity Error: Port 22 is BLOCKED or UNREACHABLE."
            echo "   Action Required: Check AWS Security Group inbound rules."
            echo "   Allow TCP 22 from 0.0.0.0/0 (temporary) or confirm IP allowlist."
            exit 1
        fi

    - name: Repo Guardrails (Forbidden Check)
      run: |
        chmod +x scripts/forbidden-check.sh
        bash scripts/forbidden-check.sh
        # Also make sure find_root.py is readable? default is fine.

    - name: Install and Build (Root)
      run: |
        npm ci
        npm run build
        
    - name: Generate Build Proof
      run: |
        SHA=$(git rev-parse --short HEAD)
        TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        echo "commit=$SHA" > dist/build-id.txt
        echo "built_at=$TS" >> dist/build-id.txt
        echo "repo=$GITHUB_REPOSITORY" >> dist/build-id.txt
        echo "Runner build-id:"
        cat dist/build-id.txt

    - name: Deploy to EC2
      env:
        HOST: ${{ secrets.HOST_IP }}
        USER: ${{ secrets.SSH_USER }}
        LINK_PATH: /var/www/torquefoundry
        RELEASES_PATH: /var/www/releases
      run: |
        # Setup SSH
        set -euo pipefail
        mkdir -p ~/.ssh
        chmod 700 ~/.ssh

        if [ -z "${{ secrets.HOST_IP }}" ]; then
          echo "‚ùå HOST_IP secret is missing/empty"
          exit 1
        fi

        echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa

        ssh-keyscan -H "${{ secrets.HOST_IP }}" >> ~/.ssh/known_hosts 2>/dev/null || true

        # 1. Archive build (root dist)
        tar -czf build.tar.gz -C dist .
        
        # 2. Upload to temp
        scp -i ~/.ssh/id_rsa build.tar.gz $USER@$HOST:/tmp/build.tar.gz
        
        # 3. Upload Helper Script
        scp -i ~/.ssh/id_rsa scripts/find_root.py $USER@$HOST:/tmp/find_root.py
        
        # 4. Path Surgery & Deploy on Server
        ssh -i ~/.ssh/id_rsa $USER@$HOST << EOF
          # Stop on error & print commands
          set -ex
          
          # Variables
          RELEASE_DIR=$RELEASES_PATH/release_\$(date +%s)
          
          # Prepare Release Directory
          sudo mkdir -p $RELEASES_PATH
          sudo mkdir -p \$RELEASE_DIR
          sudo chown $USER:$USER \$RELEASE_DIR
          
          # Extract
          tar -xzf /tmp/build.tar.gz -C \$RELEASE_DIR
          rm /tmp/build.tar.gz
          
          # ---------------------------------------------------------
          # DIAG: find nginx site config for torquefoundryadvisory.com
          # ---------------------------------------------------------
          echo "===== DIAG: find nginx site config for torquefoundryadvisory.com ====="
          CONF=\$(sudo grep -Rsl "server_name .*torquefoundryadvisory.com" /etc/nginx/sites-enabled /etc/nginx/conf.d 2>/dev/null | head -n 1 || true)
          echo "CONF=\$CONF"
          if [ -n "\$CONF" ]; then
            echo "----- CONF SNIPPET -----"
            sudo nl -ba "\$CONF" | sed -n '1,220p'
          fi

          echo "===== DIAG: nginx -T root/server_name lines (first 200 matches) ====="
          sudo nginx -T 2>/dev/null | grep -nE "server_name|root |listen|try_files|location" | head -n 200 || true
          
          # ---------------------------------------------------------
          # AUTO-DETECT ROOT (PYTHON PARSER)
          # ---------------------------------------------------------
          echo "üêç Parsing Nginx Config with Python (Robust)..."
          
          # Dump full config to file
          sudo nginx -T > /tmp/nginx_dump.conf 2>/dev/null
          
          # Execute uploaded script
          ROOT=\$(python3 /tmp/find_root.py)
          
          # Fallback mechanism
          if [ -z "\$ROOT" ]; then
             echo "‚ö†Ô∏è Parsing failed or no root found. Trying fallback candidates..."
             for p in /var/www/torquefoundry/dist /var/www/torquefoundry /usr/share/nginx/html /var/www/html; do
               if [ -f "\$p/index.html" ]; then 
                 ROOT="\$p"
                 echo "Using fallback root: \$ROOT"
                 break; 
               fi
             done
          fi
          
          echo "===== DETECTED_ROOT=\$ROOT ====="
          if [ -z "\$ROOT" ]; then
            echo "‚ùå Could not detect nginx root. Aborting surgical deploy."
            exit 1
          fi
          
          # ---------------------------------------------------------
          # DEPLOY TO ROOT (RSYNC)
          # ---------------------------------------------------------
          echo "üöÄ Deploying to DETECTED ROOT: \$ROOT"
          sudo mkdir -p "\$ROOT"
          sudo rsync -a --delete "\$RELEASE_DIR"/ "\$ROOT"/
          
          # Permissions
          sudo chown -R www-data:www-data "\$ROOT"
          sudo chmod -R 755 "\$ROOT"
          
          # Reload Nginx
          sudo systemctl reload nginx
          
          echo "===== DIAG: served root listing ====="
          ls -la "\$ROOT" | head -n 50
          echo "===== DIAG: server build-id ====="
          cat "\$ROOT/build-id.txt" || (echo "‚ùå build-id missing in served root" && exit 1)
          
          # Cleanup Script
          rm /tmp/find_root.py
          
        EOF
        
        rm ~/.ssh/id_rsa

    - name: Verify Live Deployment (Build ID)
      run: |
        echo "Waiting for Nginx reload..."
        sleep 5
        
        DOMAIN="torquefoundryadvisory.com"
        IP="${{ secrets.HOST_IP }}"
        
        echo "Checking http://${DOMAIN}/build-id.txt via origin $IP..."
        
        code=$(curl -sS -o live.txt -w "%{http_code}" --max-time 10 \
          --resolve "${DOMAIN}:80:${IP}" \
          "http://${DOMAIN}/build-id.txt" || echo "000")
        
        echo "HTTP_STATUS=$code"
        cat live.txt || true
        
        if [ "$code" -ne 200 ]; then
          echo "‚ùå FAILED: Status code $code (Expected 200)"
          # Print diagnostics if available
          echo "Diagnostics:"
          head -n 20 live.txt
          exit 1
        fi
        
        EXPECTED=$(git rev-parse --short HEAD)
        RECEIVED=$(grep -E "^commit=" live.txt | cut -d= -f2 | tr -d "\r" || true)
        
        echo "Expected=$EXPECTED"
        echo "Received=$RECEIVED"
        
        if [ "$EXPECTED" != "$RECEIVED" ]; then
          echo "‚ùå FAILED: Content mismatch"
          exit 1
        else
          echo "‚úÖ VERIFIED: Content matches commit $EXPECTED"
        fi
