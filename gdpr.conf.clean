map $remote_addr $ip_anonymized {
    default 0.0.0.0;
    "~(?P<ip>\d+\.\d+\.\d+)\."    $ip.0;
    "~(?P<ip>[^:]+:[^:]+):"       $ip::;
}

log_format anonymized '$ip_anonymized - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" "$http_user_agent"';
